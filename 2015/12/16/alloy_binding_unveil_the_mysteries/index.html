<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Alloy Binding: Unveil The Mysteries</title> <meta name="description" content="Despite some reservations about several Alloy features and choices, one does not simply ignore the most interesting feature so-called data-binding. Unfortuna..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://ktorz.github.io/2015/12/16/alloy_binding_unveil_the_mysteries/"> <link rel="alternate" type="application/rss+xml" title="KtorZ's Blog" href="http://ktorz.github.io/feed.xml"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="alternate" type="application/atom+xml" title="" href="http://ktorz.github.io/feed.xml" /> <script src="/assets/js/modernizr.js"></script> <!-- Google Analytics --> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="primary-nav"> <li><a href="/">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/KtorZ" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/matthias-benkort-47186a57" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> RSS</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Alloy Binding: Unveil The Mysteries</h1> <p class="post-meta"><time datetime="2015-12-16T16:14:52+01:00" itemprop="datePublished">Dec 16, 2015</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthias Benkort</span></span></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>Despite some reservations about several Alloy features and choices, one does not simply ignore the most interesting feature so-called data-binding. Unfortunately, the documentation on that part is rather disastrous; let’s try to provide some insights upon which rely in the future.</p> <!--more--> <p>Because the binding mainly concerns <em>Backbone</em> models (we’ll see more about how we can trick the current implementation), we’ll proceed first with model and then we’ll look at how to extend the concept to collections. Incidentally, data-binding can be used within a widget and within the widget’s scope. We’ll consider Alloy’s version &gt; 1.6 all along this post.</p> <p>I do not intend to give an explanation of what data-binding is, I assume the reader already knows the idea. This is rather a practical guide on how to use it wihtin Alloy. You should be able to use the binding on any Alloy tag, please let me know if you know any issue with a component.</p> <h2 id="model-binding">Model binding</h2> <h3 id="global-instance">Global instance</h3> <p>When using an explicit tag <code>&lt;Model&gt;</code> in an <em>xml</em> view, Alloy will assume you’re refering to a unique singleton stored in <code>Alloy.Models.&lt;model_name&gt;</code>. Should Alloy creates a new instance the first time you refer to that model. Otherwise, the same instance will be used.</p> <p>So, here we are:</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Model</span> <span class="na">src=</span><span class="s">&quot;patate&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{patate.size}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p>The snippet below will create a binding between a model instance stored in <code>Alloy.Models.patate</code>. The following rules apply here:</p> <ul> <li>Alloy will create an instance of the model if it does not exist</li> <li>A model file has to be present in the <code>models/</code> folder</li> <li>The model file should have the same name as indicated in <code>src</code> plus a <code>.js</code> extension</li> <li>Alloy will listen to <code>fetch</code>, <code>change</code> and <code>destroy</code> events from Backbone</li> <li>The <code>destroy()</code> method has to be called explicitely to unbind the model</li> <li>The model can define a <code>transform()</code> method which return an object on which properties are going to be accessed</li> <li>Without any <code>transform()</code> method, Alloy will consider the <code>toJSON()</code> method provided by Backbone for each model</li> </ul> <p>Incidentally, if there is already an existing instance, we can just omit the <code>&lt;Model&gt;</code> tag and directely refer to the model via string interpolation. To me, it makes more sense to create the singleton in a separated file, for instance <code>Alloy.js</code> and keep away from the view file that ugly <code>&lt;Model&gt;</code>.</p> <p>If you try to reference a non-existing model, alloy will refuse to compile with a nice error message if you provide an invalid <code>src</code> attribute or, with a message a bit more irrelevant if you just specified an invalid base for the interpolation. In both cases, this just mean that you should only bind to existing model.</p> <h3 id="local-instance">Local instance</h3> <p>What if you just need a local instance of your model? Well, there are some attributes you may add to the <code>&lt;Model&gt;</code> to do so.</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Model</span> <span class="na">src=</span><span class="s">&quot;patate&quot;</span> <span class="na">instance=</span><span class="s">&quot;true&quot;</span> <span class="na">id=</span><span class="s">&quot;mypatate&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{$.mypatate.size}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p>Notice the <code>$.patate</code> now in the interpolation and the two new attributes in the model tag.</p> <p>Each previous rules also apply in that case. The only difference is that, instead of storing and trying to access the model instance from <code>Alloy.Models</code>, this will rather place the instance within your controller instance and thus, give you access through <code>$.&lt;model_id&gt;</code>.</p> <p>Unlike the global instance, you cannot omit the <code>&lt;Model&gt;</code> tag, nor the <code>id</code> attributes. Without any <code>id</code>, the instance will be stored in your controller under a name computed by the compiler, hard to guess at runtime for you. And, without any tag, the model just won’t be created and you’ll end up with a nice error when Alloy will try to bind Backbone event on an undefined instance when executing the controller. You cannot bind to an existing instance doing that.</p> <p>By the by, <code>instance</code> and <code>id</code> are inseparable. There is no point of considering one without the other.</p> <h3 id="existing-instance">Existing instance</h3> <p>Well, sometimes, you still want to bind to an existing instance. Did I say this was impossible? That wasn’t exactly true. From the mysterious valleys of Alloy source code, you can notice that Alloy actually processes your controller arguments and has a dedicated processing for several of them. The <code>$model</code> is one of them.</p> <p>Thus, from a view file, you can interpolate the following way:</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{size}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p>This syntax assumes that an argument <code>$model</code> (no point) has been passed to your controller with one condition. It should be an object with a property <code>__transform</code> which should also point to an object, empty or not. Because Alloy will try to access this property directly, if you omit it, the application will crash at runtime. By the by, this object does have to be a Backbone model, yet merely an object which defines a <em>__transform</em> attribute.</p> <p>You can see the <code>__transform</code> property as the result of either the <code>transform()</code> or the <code>toJSON()</code> methods we mentionned above. You can populate this object with properties that need to be accessed (<code>size</code> in our example). Besides, if the property is undefined within the <code>__transform</code> object, Alloy will presume that <code>$model</code> is a Backbone instance and will try to access the property via <code>$model.get('&lt;property_name&gt;')</code>.</p> <h3 id="remarks">Remarks</h3> <ul> <li><strong>Beware of caps</strong></li> </ul> <p>If you use a capitalized name for your model, use the downcase name when refering to it in the interpolation. Alloy stores models names as lower cases.</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Model</span> <span class="na">src=</span><span class="s">&quot;Patate&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{patate.size}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <ul> <li><strong>Don’t nest properties</strong></li> </ul> <p>If your model holds an object, you won’t be able to access its nested properties when interpolating. Thus, take advantage of the <code>transform()</code> method or <code>__transform</code> object to provide a facade for those properties.</p> <ul> <li><strong>Several interpolations with toJSON()</strong></li> </ul> <p>If you <strong>don’t</strong> define a <code>transform()</code> method, you can take advantage of Backbone templates and use several interpolation tags in a same string. This won’t compile nevertheless if you’re using the <code>$model</code> trick, and won’t work as expected if <code>transform()</code> is defined (in that case, only the first interpolation will be rendered).</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{patate.greetings}: {patate.size}cm&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <ul> <li><strong>Already hydrated models</strong></li> </ul> <p>Keep in mind that the view associated to your model will only render and re-render when a <code>fetch</code>, <code>change</code> or <code>destroy</code> event occurs. This means that if you try to bind a view to an already instantiated model that already possesses its data, you won’t see the view as expected. If you’re in such a case, <code>&lt;your-model&gt;.trigger('change')</code> will do the trick.</p> <h2 id="collection-binding">Collection binding</h2> <p>Let’s step up the game a bit. One model wasn’t enough, we want a complete collection of them. The idea is quite similar than before should we just add one concept. Each model of the collection are going to be rendered within a container. It feels natural to use containers such as <code>listview</code> or <code>tableview</code> however, one can use any view object as a container (again, let me know if you encounter any issue with a given UI object).</p> <p>Thus, given a container which will hold the collection, we need to defined a nested repeater which will be used to instantiate all children view elements associated to each model of the collection. The nested repeater element depends of the nature of the container. The table in the current documentation is quite accurate though still a bit incomplete. In practice, it is possible to use <code>ScrollView</code> and in fact, any other <code>View</code> (or component extending <code>View</code>) as a container and then use any UI component that extends <code>View</code> as a repeater (<code>ImageView</code> for instance).</p> <h3 id="global-instance-1">Global Instance</h3> <p>In the same manner as for models you may use a <code>Collection</code> markup tag to create a global collection instance of an existing model (the name you supply should exist within your <code>models</code> folder). The instance is stored under <code>Alloy.Collections</code> meaning that, the same instance will be used between several controllers.</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;Collection</span> <span class="na">src=</span><span class="s">&quot;patate&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;View</span> <span class="na">dataCollection=</span><span class="s">&quot;patate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{size}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/View&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p>You can omit the <code>Collection</code> tag as well and this supposes that there is an existing instance stored in <code>Alloy.Collections</code>. Incidentally, doing that, you’re able to give any name you want to the collection, it does not have to fit an existing model of your <code>models</code> folder. This is quite interesting if you want to keep different collections holding the same type of models.</p> <p>Notice how we identified the container component with the <code>dataCollection</code> attribute. A collection holder which as been tagged like this can also define 3 other attributes:</p> <ul> <li><strong>dataFunction</strong></li> </ul> <p>This property allows you to create an alias accessible within your controller to render the view on demand. This is useful when you’re binding to an already populated collection; By using the provided function, you can render the data even if no Backbone event has been raised. You don’t need the trick mentionned in the model section, here’s a dedicated function.</p> <p>Using <code>dataFunction</code> is quite straightforward:</p> <p><strong>view.xml</strong></p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;View</span> <span class="na">dataCollection=</span><span class="s">&quot;patate&quot;</span> <span class="na">dataFunction=</span><span class="s">&quot;render&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{size}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/View&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p><strong>controller.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Some code above </span>

<span class="nx">render</span><span class="p">()</span> <span class="c1">// Will behave the same as receiving a watched Backbone event on the collection </span>

<span class="c1">// Some code after</span></code></pre></figure> <ul> <li><strong>dataFilter</strong></li> </ul> <p>You have the possibility to filter the given collection to only render a part of that collection. This is done by providing a filtering function via the <code>dataFilter</code> attribute. The function takes a collection as an argument and is expecting to return an array of models.</p> <p><strong>view.xml</strong></p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;View</span> <span class="na">dataCollection=</span><span class="s">&quot;patate&quot;</span> <span class="na">dataFilter=</span><span class="s">&quot;filter&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{size}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/View&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p><strong>controller.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Only patate with a size &gt; 10</span>
<span class="kd">function</span> <span class="nx">filter</span> <span class="p">(</span><span class="nx">xs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">xs</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="p">})</span>
<span class="p">}</span></code></pre></figure> <p>Incidentally, this is quite useful to render different parts of the screen with data extracted from solely one collection.</p> <ul> <li><strong>dataTransform</strong></li> </ul> <p>Remember the <code>transform()</code> method we could define on models ? Well, it doesn’t apply automatically to model inside a collection. Still, you can apply some transformations to your models by providing an appropriate function via the <code>dataTransform</code> property. The function will run for each model stored in the collection and should return a JSON representation of that model. The most convenient way to use it is probably to take advantage of the <code>transform()</code> method already defined for the associated model which could be done in either one of the following ways:</p> <p><strong>view.xml</strong></p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Alloy&gt;</span>
    <span class="nt">&lt;View</span> <span class="na">dataCollection=</span><span class="s">&quot;patate&quot;</span> <span class="na">dataTransform=</span><span class="s">&quot;transform&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Label</span> <span class="na">text=</span><span class="s">&quot;{size}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/View&gt;</span>
<span class="nt">&lt;/Alloy&gt;</span></code></pre></figure> <p><strong>controller.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">transform</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">transform</span><span class="p">()</span> <span class="p">}</span>

<span class="c1">// Or</span>

<span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;alloy/models/&lt;Model&gt;&#39;</span><span class="p">).</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transform</span><span class="p">)</span></code></pre></figure> <h3 id="local-instance-1">Local instance</h3> <p>I won’t spend a lot of time on that part. This is highly similar to what is done with models. You can add an <code>id</code> and a <code>instance</code> attributes to the <code>Collection</code> tag to create a local instance of the given collection. The collection is thereby stored under <code>$.&lt;id&gt;</code> and respect all previously written rules about collections.</p> <h3 id="remarks-1">Remarks</h3> <ul> <li><strong>destroy()</strong></li> </ul> <p>Remember, you still have to call <code>$.destroy()</code> once done to remove all bindings that apply on collections. Without this, the garbage collector won’t be able to free the memory after the controller life.</p> <ul> <li><strong>Already populated collection</strong></li> </ul> <p>This remark is identical to the one about models. Your collection will only be rendered if Backbone trigger one the listened events (<code>fetch</code>, <code>destroy</code>, <code>change</code>, <code>add</code>, <code>remove</code> or <code>reset</code>) unless you made an explicit call to the function aliased by <code>dataFunction</code></p> <ul> <li><strong>Widgets</strong></li> </ul> <p>Widgets work merely the same way as Controllers. One can thereby use binding features within a widget with those subtle differences:</p> <ul> <li>Model and Collection instances are stored under <code>Widget.&lt;Models|Collections&gt;.&lt;id&gt;</code>.</li> <li>You can use any model defined at your application level but you may also define your own private models in the widget’s folder</li> <li>You cannot omit the <code>&lt;Model&gt;</code> tag and access a model stored in <code>Widget.Models</code> this way.</li> <li>You cannot access models via a global instance. You need to specify an <code>id</code> and <code>instance</code> for every <code>Model</code> tag.</li> <li>You can specify any model name to the <code>src</code> attribute (even one that does not reflect an existing model).</li> </ul> <p>I guess this is it. Enjoy the inconsistency!</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/KtorZ" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/matthias-benkort-47186a57" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/mbenkort" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2016 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html><!-- by nandomoreira.me -->